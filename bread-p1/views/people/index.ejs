<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SQLite Bread</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container my-3"><!-- back to normal container -->
  <div class="card">
    <div class="card-body">
      <h3 class="text-center fw-bold mb-3">SQLite Bread (Browse, Read, Edit, Add, Delete) and Pagination</h3>
      <form method="get" action="/">
        <div class="row mb-2">
          <div class="col-md-2"><label class="form-label">Name</label></div>
          <div class="col-md-10"><input class="form-control" name="name" placeholder="insert your name" value="<%= filters.name %>"></div>
        </div>
        <div class="row mb-2">
          <div class="col-md-2"><label class="form-label">Height</label></div>
          <div class="col-md-10"><input class="form-control" name="height" placeholder="insert your height" value="<%= filters.height %>"></div>
        </div>
        <div class="row mb-2">
          <div class="col-md-2"><label class="form-label">Weight</label></div>
          <div class="col-md-10"><input class="form-control" name="weight" placeholder="insert your weight" value="<%= filters.weight %>"></div>
        </div>
        <div class="row mb-2 align-items-center">
          <div class="col-md-2"><label class="form-label">Birth Date</label></div>
          <div class="col-md-4">
            <input type="date" class="form-control" name="birth_date_start" value="<%= filters.birth_date_start || '' %>">
          </div>
          <div class="col-md-1 text-center">s.d.</div>
          <div class="col-md-5">
            <input type="date" class="form-control" name="birth_date_end" value="<%= filters.birth_date_end || '' %>">
          </div>
        </div>
        <div class="row mb-2">
          <div class="col-md-2"><label class="form-label">Is Married</label></div>
          <div class="col-md-10">
            <select class="form-select" name="is_married">
              <option value="">-select married-</option>
              <option value="Yes" <%= filters.is_married==='Yes'?'selected':'' %>>Yes</option>
              <option value="Not Yet" <%= filters.is_married==='Not Yet'?'selected':'' %>>Not Yet</option>
            </select>
          </div>
        </div>
        <div class="row mb-2">
          <div class="col-md-2"><label class="form-label">Operation</label></div>
          <div class="col-md-10">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="operation" value="OR" <%= operation==='OR'?'checked':'' %>>
              <label class="form-check-label">OR</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="operation" value="AND" <%= operation==='AND'?'checked':'' %>>
              <label class="form-check-label">AND</label>
            </div>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-12 d-flex gap-2">
            <button type="submit" class="btn btn-info text-white">Search</button>
            <a href="/" class="btn btn-warning">Reset</a>
          </div>
        </div>
      </form>
    </div>
  </div>

  <table class="table table-striped mt-3">
    <thead>
      <tr><th>No.</th><th>Name</th><th>Height</th><th>Weight</th><th>Birth Date</th><th>Is Married</th><th>actions</th></tr>
    </thead>
    <tbody>
      <% if (people.length===0){ %><tr><td colspan="7" class="text-center">No data</td></tr><% } %>
      <% people.forEach((p,i)=>{ %>
      <tr>
        <td><%= (page-1)*5+i+1 %></td>
        <td><%= p.name %></td>
        <td><%= p.height %></td>
        <td><%= p.weight %></td>
        <td><%= p.birth_date %></td>
        <td><%= p.is_married %></td>
        <td>
          <a href="/edit/<%= p.id %>" class="btn btn-success btn-sm">Update</a>
          <!-- delete button opens modal -->
          <button class="btn btn-danger btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#deleteModal"
                  data-id="<%= p.id %>"
                  data-name="<%= p.name %>">
            Delete
          </button>
        </td>
      </tr>
      <% }) %>
    </tbody>
  </table>

  <div class="d-flex justify-content-between align-items-center">
    <a href="/new" class="btn btn-primary">Add</a>
    <nav>
      <% 
        const query = Object.entries(filters)
          .filter(([k,v]) => v)
          .map(([k,v]) => `${k}=${encodeURIComponent(v)}`)
          .concat([`operation=${operation}`])
          .join('&');
        const qs = query ? '&'+query : '';
      %>
      <ul class="pagination mb-0">
        <li class="page-item <%= page<=1?'disabled':'' %>">
          <a class="page-link" href="/?page=<%= page-1 %><%= qs %>">&laquo;</a>
        </li>
        <% for (let i=1;i<=totalPages;i++){ %>
          <li class="page-item <%= i===page?'active':'' %>">
            <a class="page-link" href="/?page=<%= i %><%= qs %>"><%= i %></a>
          </li>
        <% } %>
        <li class="page-item <%= page>=totalPages?'disabled':'' %>">
          <a class="page-link" href="/?page=<%= page+1 %><%= qs %>">&raquo;</a>
        </li>
      </ul>
    </nav>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Confirmation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="deleteMessage">Are you sure you want to delete this record?</p>
      </div>
      <div class="modal-footer">
        <form id="deleteForm" method="post">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
          <button type="submit" class="btn btn-warning">Yes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const deleteModal = document.getElementById('deleteModal');
  deleteModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    const id = button.getAttribute('data-id');
    const name = button.getAttribute('data-name');

    const message = deleteModal.querySelector('#deleteMessage');
    message.textContent = `Apakah kamu yakin akan menghapus data '${name}'?`;

    const form = deleteModal.querySelector('#deleteForm');
    form.action = `/delete/${id}`;
  });
</script>
</body>
</html>
